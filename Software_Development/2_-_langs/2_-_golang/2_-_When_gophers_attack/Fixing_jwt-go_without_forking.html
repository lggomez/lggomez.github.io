
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="alternate" type="application/rss+xml" href="https://luisgg.me/rss.xml" title="Luis GG - Tales and notes">
    
    <meta property="og:image" content="http://luisgg.me/_assets/about-me/og.jpeg" />
    <meta property="og:title" content="Fixing and extending jwt-go without forking" />
    <meta property="og:description" content="Luis GG - Tales and notes" />

	<!-- favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <title>Fixing and extending jwt-go without forking</title>
    <meta name="generator" content="Zim 0.73.4-da75848">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="../../../../_resources/style.css" type="text/css"/>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>

    <script src="../../../../_resources/jquery-toc-0.4.0.js" type="text/javascript"></script>

    <script type="text/javascript">
		$(window).on('load', function () {
			// Initialize highlight.js formatter
			$('pre code').each(function (i) {
				hljs.highlightBlock(this);
            });
            
            if ($("h2").length != 0)
            $("#tocdata").toc({content: "#content", headings: "h2,h3,h4"});
            else
                $("#toc").hide();
            $("#navigation").children("ul").prepend("<li class='index-item'><a href='../../../../index.html'>Index</a></li>");

            $(".toggle").addClass('toggle-off');
            $(".toggle").click(function(){
                $("#navigation").children("ul").toggle();
                var vwWidth = $(window).width();
                if ($(".toggle").hasClass('toggle-on')) {
                    $(".toggle").removeClass('toggle-on');
                    $(".toggle").addClass('toggle-off');
                    $(".wrapper").css('max-width', vwWidth + '%');
                    $(".wrapper").css('width', vwWidth + 'vw');
                } else if ($(".toggle").hasClass('toggle-off')) {
                    $(".toggle").removeClass('toggle-off');
                    $(".toggle").addClass('toggle-on');
                    $(".wrapper").css('max-width', vwWidth + '%');
                    $(".wrapper").css('width', vwWidth + 'vw');
                }
            });
            $("img").wrap("<div class='imgcenter'></div>");
        });
	</script>
</head>
<body>
    <noscript>
        <div style="border: 1px solid purple; padding: 10px">
            <span style="color:red">This page is best viewed with JavaScript enabled!</span>
        </div>
    </noscript>

    <table id="wrapper">
        <tr>
            <td id="navigation" rowspan="2">
                <svg class="toggle">
                    <line x1="10" y1="10" x2="40" y2="10" />
                    <line x1="10" y1="20" x2="40" y2="20" />
                    <line x1="10" y1="30" x2="40" y2="30" />
                </svg> 
                <ul>
<li><a href="../../../../About_Me.html" title="About Me" class="page">About Me</a></li>
<li><a href="../../../../About_RSS_feed.html" title="About RSS feed" class="page">About RSS feed</a></li>
<li><a href="../../../../Arduno_and_electronics.html" title="Arduno and electronics" class="page">Arduno and electronics</a></li>
<li><a href="../../../../Misc.html" title="Misc" class="page">Misc</a></li>
<li><a href="../../../../Software_Development.html" title="Software Development" class="page">Software Development</a>
<ul>
<li><a href="../../../1_-_Talks_and_Presentations.html" title="1 - Talks and Presentations" class="page">1 - Talks and Presentations</a></li>
<li><a href="../../../2_-_langs.html" title="2 - langs" class="page">2 - langs</a>
<ul>
<li><a href="../../1_-_dotNET.html" title="1 - dotNET" class="page">1 - dotNET</a></li>
<li><a href="../../2_-_golang.html" title="2 - golang" class="page">2 - golang</a>
<ul>
<li><a href="../1_-_Talks_and_Presentations.html" title="1 - Talks and Presentations" class="page">1 - Talks and Presentations</a></li>
<li><a href="../2_-_When_gophers_attack.html" title="2 - When gophers attack" class="page">2 - When gophers attack</a>
<ul>
<li><b>Fixing jwt-go without forking</b></li>
<li><a href="./Forgetting_that_precious_recover.html" title="Forgetting that precious recover" class="page">Forgetting that precious recover</a></li>
<li><a href="./Log_everything,_just_not_every_single_thing.html" title="Log everything, just not every single thing" class="page">Log everything, just not every single thing</a></li>
<li><a href="./That_one_with_the_go_runtime_bug.html" title="That one with the go runtime bug" class="page">That one with the go runtime bug</a></li>
</ul>
</li>
<li><a href="../Scaffolding_RSS_feeds_from_zim_notebooks.html" title="Scaffolding RSS feeds from zim notebooks" class="page">Scaffolding RSS feeds from zim notebooks</a></li>
</ul>
</li>
<li><a href="../../The_otherworldly_landscape_of_enums_in_go.html" title="The otherworldly landscape of enums in go" class="page">The otherworldly landscape of enums in go</a></li>
</ul>
</li>
<li><a href="../../../3_-_Articles.html" title="3 - Articles" class="page">3 - Articles</a></li>
<li><a href="../../../4_-_Notes.html" title="4 - Notes" class="page">4 - Notes</a></li>
</ul></li>
</ul>

            </td>

            <td id="header">
                <h1><a href="/">Luis GG - Tales and notes</a></h1>
            </td>
        </tr>

        <tr>
            <td id="content">


                    <h1>Fixing and extending jwt-go without forking <a name='Software Development:2 - langs:2 - golang:2 - When gophers attack:Fixing jwt-go without forking'></a></h1>
                    <div id="toc">			
                        <div class="toctitle">Contents</div>				
                        <ul id="tocdata"></ul>
                    </div>		

                <p>
Created Thursday 07 January 2021
</p>

<p>
Drama isn't usual in the go community as far as I'm concerned and I wouldn't call this incident itself a drama but it reminds me of instances that happen more than often on other technology stacks [citation omitted]
</p>

<p>
Security utilities are no joke, and no one in their sane mind would go about writing a custom RSA implementation in C++ for, say, their bank employer. People dedicate their entire careers writing this stuff and any modern platform or programming language has a security toolset for developing applications, and, otherwise, the open source solutions which are battle-tested by the community offer more guarantee that a one-man solution. Which brings us to today's entry
</p>

<p>
Go contains several official packages related to security but, to my surprise when I looked around, there was no canonical JWT implementation. I needed to do some token verification and introspection, and I decided to go with <a href="https://github.com/dgrijalva/jwt-go," title="https://github.com/dgrijalva/jwt-go," class="https">https://github.com/dgrijalva/jwt-go,</a> as it seems to be one of the most popular packages  with an API that looked pretty ergonomic for my use case
</p>

<p>
However, as of today it still has a security flaw: <a href="https://github.com/dgrijalva/jwt-go/issues/428" title="https://github.com/dgrijalva/jwt-go/issues/428" class="https">https://github.com/dgrijalva/jwt-go/issues/428</a>
</p>

<p>
The repo is not maintained anymore (altough is stable aside from that issue) and the owner is nowhere to be found, or neither wants to be found. In the context of dependency management, this problem brings up some questions:<br>
<ul>
<li>Is it viable to use a fork at the cost of fragmentation?</li>
<li>What happens to versions which were already audited by some process? a fork and new owner implies a full re-audit of the dependency?</li>
<li>Why is google in the <a href="https://pkg.go.dev/github.com/dgrijalva/jwt-go?tab=importedby" title="list" class="https">list</a> of users of this package and didn't bother to do a fork, or better yet, an official package like in the case of oauth?</li>
</ul>
</p>

<p>
Really interesting questions but for which I didn't have the answers, or the time to find them as I wanted to finish my implementation. Moving to another, more interesting question, how much of the package would I need to copy or re-implement in order to fix this without doing a complete fork or having to move on to another package?
</p>

<h2>Not so tight, not so loose coupling</h2>

<p>
The basic workflow goes like this:
</p>

<div class="zim-object">
<pre><code class="golang">import (
    jwtgo "https://github.com/dgrijalva/jwt-go"
)

claims := jwtgo.MapClaims{}

// Traverse JWKS and validate/match by kid (ideally)
for _, key := range publicKeys {
    token, err := jwtgo.ParseWithClaims(rawStringJWT, &amp;claims, func(t *jwtgo.Token) (interface{}, error) {
        // Revalidate signing method to prevent bypass attacks
        // ...
        
        return key.PublicKey, nil // PublicKey is my *rsa.PublicKey instance containing the valid key to verify the token
    })
}
</code></pre>
</div>

<p>
The issue is in the jwtgo.MapClaims type, which contains the bug, but wait: the ParseWithClaims method expects a Claims parameter, which is an interface:
</p>

<div class="zim-object">
<pre><code class="golang">type Claims interface {
	Valid() error
}
</code></pre>
</div>

<h2>Extending</h2>

<p>
The So, knowing this, we can implement our custom type, namely a copy of the fixed implementation of the jwtgo.MapClaims type (for reference, see <a href="https://github.com/dgrijalva/jwt-go/pull/385" title="https://github.com/dgrijalva/jwt-go/pull/385" class="https">https://github.com/dgrijalva/jwt-go/pull/385</a>). This type complies with Claims interface and can be extended to advanced validations, like required and optional claims:
</p>

<div class="zim-object">
<pre><code class="golang">type MyFixedClaims = jwtgoclaims.MapClaims // alias to subpackage containing the fixed claims implementation
// for clarity and easier replacement later on if the author
// is alive and decides to merge the pull request

type ClaimValue struct {
	Value string
	Required bool
}

type ClaimsVerificationValues map[string]ClaimValue

func VerifyMyClaims(myClaims MyFixedClaims, verifier ClaimsVerificationValues) error {
	for k, v := range verifier {
		if err := verifyValue(myClaims, v.Value, k, v.Required); err != nil {
			return err
		}
	}
}

func verifyValue(c MyFixedClaims, expected, key string, required bool) error {
	val, found := c[key]
	actual, ok := val.(string)
	if !(found &amp;&amp; ok) &amp;&amp; required {
		return fmt.Errorf("%v verification failed", key)
	}
	
	
	if required {
		if !ok || actual == "" {
			return fmt.Errorf("%v verification failed", key)
		}
	} else if actual == "" {
		return nil
	}
	
	if actual != expected {
		return fmt.Errorf("%v verification failed", key)
	}
	
	return nil
}
</code></pre>
</div>

<p>
I'd like to think there is a nicer way of doing the last method, so I will leave that up to the reader
</p>

<h2>Wrapping up</h2>

<p>
With that, our initial code piece would end up like this:
</p>

<div class="zim-object">
<pre><code class="golang">import (
    jwtgo "https://github.com/dgrijalva/jwt-go"
)

claims := MyFixedClaims{}
verificationValues := ClaimsVerificationValues{
	"customclaim": ClaimValue{Value:"foo", Required: true},
	"konamicode": ClaimValue{Value:"↑ ↑ ↓ ↓ ← → ← → B A", Required: false}
}

// Traverse JWKS and validate/match by kid (ideally)
for _, key := range publicKeys {
    token, err := jwtgo.ParseWithClaims(rawStringJWT, &amp;claims, func(t *jwtgo.Token) (interface{}, error) {
        // Revalidate signing method to prevent bypass attacks
        // ...
        
        if err := VerifyMyClaims(claims, verificationValues); err != nil {
        	return nil, err
        }
        
        // ...
        
        return key.PublicKey, nil // PublicKey is my *rsa.PublicKey instance containing the valid key to verify the token
    })
}
</code></pre>
</div>

<p>
Drama is avoided. Pending refactor is all that remains
</p>

<p>
<i><b>PS:</b> Be nice and don´t forget to include the licenses belonging to the code you fork when applicable</i>
</p>


        

                
            </td>
        </tr>
        
        <tr>
            <td id="credits" colspan="2">
                <p><i><strong>Author:</strong> Luis Gabriel Gomez</i></p>
                <p><i><strong>Disclaimer:</strong> I may not own the entirety of the site media (including logos, images), thus being used under a fair use policy. All credits go to their rightful owners.</i></p>
                <p><i>This site was generated using <a href='https://zim-wiki.org'>Zim 0.73.4-da75848</a> and an author-made <a href='https://github.com/lggomez/zim-templates-gh'>theme</a> based on <a href="https://github.com/gandrille/zim-simple-web-template">Etienne Gandrille's.</a></i></p>
            </td>
        </tr>
    </table>

</body>
</html>
