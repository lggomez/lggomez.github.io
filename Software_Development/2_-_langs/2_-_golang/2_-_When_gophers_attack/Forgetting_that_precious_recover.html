
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="alternate" type="application/rss+xml" href="https://luisgg.me/rss.xml" title="Luis GG - Tales and notes">
    
    <meta property="og:image" content="http://luisgg.me/_assets/about-me/og.jpeg" />
    <meta property="og:title" content="Forgetting that precious recover" />
    <meta property="og:description" content="Luis GG - Tales and notes" />

	<!-- favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <title>Forgetting that precious recover</title>
    <meta name="generator" content="Zim 0.73.4-da75848">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="../../../../_resources/style.css" type="text/css"/>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>

    <script src="../../../../_resources/jquery-toc-0.4.0.js" type="text/javascript"></script>

    <script type="text/javascript">
		$(window).on('load', function () {
			// Initialize highlight.js formatter
			$('pre code').each(function (i) {
				hljs.highlightBlock(this);
            });
            
            if ($("h2").length != 0)
            $("#tocdata").toc({content: "#content", headings: "h2,h3,h4"});
            else
                $("#toc").hide();
            $("#navigation").children("ul").prepend("<li class='index-item'><a href='../../../../index.html'>Index</a></li>");

            $(".toggle").addClass('toggle-off');
            $(".toggle").click(function(){
                $("#navigation").children("ul").toggle();
                var vwWidth = $(window).width();
                if ($(".toggle").hasClass('toggle-on')) {
                    $(".toggle").removeClass('toggle-on');
                    $(".toggle").addClass('toggle-off');
                    $(".wrapper").css('max-width', vwWidth + '%');
                    $(".wrapper").css('width', vwWidth + 'vw');
                } else if ($(".toggle").hasClass('toggle-off')) {
                    $(".toggle").removeClass('toggle-off');
                    $(".toggle").addClass('toggle-on');
                    $(".wrapper").css('max-width', vwWidth + '%');
                    $(".wrapper").css('width', vwWidth + 'vw');
                }
            });
            $("img").wrap("<div class='imgcenter'></div>");
        });
	</script>
</head>
<body>
    <noscript>
        <div style="border: 1px solid purple; padding: 10px">
            <span style="color:red">This page is best viewed with JavaScript enabled!</span>
        </div>
    </noscript>

    <table id="wrapper">
        <tr>
            <td id="navigation" rowspan="2">
                <svg class="toggle">
                    <line x1="10" y1="10" x2="40" y2="10" />
                    <line x1="10" y1="20" x2="40" y2="20" />
                    <line x1="10" y1="30" x2="40" y2="30" />
                </svg> 
                <ul>
<li><a href="../../../../About_Me.html" title="About Me" class="page">About Me</a></li>
<li><a href="../../../../About_RSS_feed.html" title="About RSS feed" class="page">About RSS feed</a></li>
<li><a href="../../../../Arduno_and_electronics.html" title="Arduno and electronics" class="page">Arduno and electronics</a></li>
<li><a href="../../../../Misc.html" title="Misc" class="page">Misc</a></li>
<li><a href="../../../../Software_Development.html" title="Software Development" class="page">Software Development</a>
<ul>
<li><a href="../../../1_-_Talks_and_Presentations.html" title="1 - Talks and Presentations" class="page">1 - Talks and Presentations</a></li>
<li><a href="../../../2_-_langs.html" title="2 - langs" class="page">2 - langs</a>
<ul>
<li><a href="../../1_-_dotNET.html" title="1 - dotNET" class="page">1 - dotNET</a></li>
<li><a href="../../2_-_golang.html" title="2 - golang" class="page">2 - golang</a>
<ul>
<li><a href="../1_-_Talks_and_Presentations.html" title="1 - Talks and Presentations" class="page">1 - Talks and Presentations</a></li>
<li><a href="../2_-_When_gophers_attack.html" title="2 - When gophers attack" class="page">2 - When gophers attack</a>
<ul>
<li><a href="./Fixing_jwt-go_without_forking.html" title="Fixing jwt-go without forking" class="page">Fixing jwt-go without forking</a></li>
<li><b>Forgetting that precious recover</b>
<ul>
<li><a href="./Forgetting_that_precious_recover/ES.html" title="ES" class="page">ES</a></li>
</ul>
</li>
<li><a href="./Log_everything,_just_not_every_single_thing.html" title="Log everything, just not every single thing" class="page">Log everything, just not every single thing</a></li>
<li><a href="./That_one_with_the_go_runtime_bug.html" title="That one with the go runtime bug" class="page">That one with the go runtime bug</a></li>
</ul>
</li>
<li><a href="../Scaffolding_RSS_feeds_from_zim_notebooks.html" title="Scaffolding RSS feeds from zim notebooks" class="page">Scaffolding RSS feeds from zim notebooks</a></li>
</ul>
</li>
<li><a href="../../The_otherworldly_landscape_of_enums_in_go.html" title="The otherworldly landscape of enums in go" class="page">The otherworldly landscape of enums in go</a></li>
</ul>
</li>
<li><a href="../../../3_-_Articles.html" title="3 - Articles" class="page">3 - Articles</a></li>
<li><a href="../../../4_-_Notes.html" title="4 - Notes" class="page">4 - Notes</a></li>
</ul></li>
</ul>

            </td>

            <td id="header">
                <h1><a href="/">Luis GG - Tales and notes</a></h1>
            </td>
        </tr>

        <tr>
            <td id="content">


                    <h1>Forgetting that precious recover <a name='Software Development:2 - langs:2 - golang:2 - When gophers attack:Forgetting that precious recover'></a></h1>
                    <div id="toc">			
                        <div class="toctitle">Contents</div>				
                        <ul id="tocdata"></ul>
                    </div>		

                <p>
Created Saturday 02 January 2021
</p>

<p>
<i>This is a public post-mortem that was intended to be released on the engineering blog of MercadoLibre, but my departure (and the slowness of the editing) prevented that.</i>
</p>

<h2>The event</h2>

<p>
It December 28, 2018, the year's last friday when our shipping calculator triggered an alert. This component is responsible of delivering the estimated delivery time along with the delivery options for a given article.
</p>

<p>
From our team, in our NewRelic monitors we saw the cause was due to a strong degradation of the API response times. I guess it was time to leave aside the panettone leftovers and start diagnosing the issue.
</p>

<p>
Our metrics pointed to a specific flow, <b>SLA Coverage Brazil</b> (carrier coverage by service level agreement). Under the hood one of its dependencies was the culprit: <b>service coverage.</b>
</p>

<h2>The diagnosis</h2>

<p>
So, right now, our monitors showed that:<br>
<ul>
<li>In service coverage, the apdex and the execution/runtime metrics were degraded by a 100%, at the same time on the whole instance pool, during the window of just a couple of minutes</li>
<li>This service failure triggers retries, adding an extra 300K requests per minute (RPM) and (not so) gracefully becoming a cascading failure</li>
</ul>
</p>

<p>
In the meanwhile, we were manually rebooting instances while adding new ones to the pool in an attempt to boost the service health. Additionally, we start observing replaced instances (that is, an instances that dies due to a process error and gets replaced by a new one).
</p>

<p>
So, from this point, the following events unfold:
</p>

<p>
<ol type="1" start="1">
<li>We identify test request starting before the event</li>
<li>We locate the client and stop said traffic</li>
<li>The instances slowly recover and the apdex goes green</li>
</ol>
</p>

<p>
Among the confusion this created (the traffic was just a couple dozen requests) we retraced our steps and found the real cause of the downtime, something we discarded on the beginning: the panics
</p>

<p>
After checking the service coverage logs, we had seen panics but quickly omitted them due to their frequency and the fact that they didn't seem related to our particular problem
</p>

<h2>What happened?</h2>

<p>
<i>“...panics do not propagate between goroutines, and must be handled independently.”</i>
</p>

<p>
When observing the panic stacktraces, we found the same pattern:<br>
<ol type="1" start="1">
<li>The stack frames did not include any of our recovery mechanisms at all, so this wasn't being handled</li>
<li>The offending code came from a goroutine</li>
</ol>
</p>

<p>
As you can see in this <a href="https://github.com/golang/go/issues/20161" title="issue" class="https">issue</a>, one design detail of golang that gets easily overlooked at first is that panics do not propagate between goroutines, and must be handled independently.
</p>

<p>
When a panic happens inside a go application process, and does not recover it, it finalizes in an anomalous way (exit code ≠ 0).
</p>

<p>
Our web application stack included a recovery middleware for all things happening in the entrant goroutine that gets covered by it, but any new goroutine must have its recovery mechanism defined explicitly.
</p>

<h2>Implications (a.k.a panics for dummies)</h2>

<p>
If a panic occurs on a gorountine without a recover(), the callee isn't going to handle it, regardless of its recovery stack frame count, and the application will die.
</p>

<p>
It is a known issue and a non-negotiable design change for go 1.x (fingers crossed for go 2.x)
</p>

<p>
Compare the following examples, this one has a propagated (unhandled panic):
</p>
<div class="zim-object">
<pre><code class="golang">package main

import (
	"fmt"
	"time"
)

func main() {
	Go(test)
	time.Sleep(time.Second)
	fmt.Printf("HELLO")
}

func test() {
	panic("PANIC")
}

func Go(f func()) {
	defer func() {
		if r := recover(); r != nil {
			fmt.Printf("RECOVERED ERROR %v", r)
		}
	}()
	go f()
}

</code></pre>
</div>

<p>
And this one handles the panic. You may notice that this code is in need of some composability:
</p>
<div class="zim-object">
<pre><code class="golang">package main

import (
	"fmt"
	"time"
)

func main() {
	Go(test)
	time.Sleep(time.Second)
	fmt.Printf("HELLO")
}

func test() {
	panic("PANIC")
}

func Go(f func()) {
	go func() {
		defer func() {
			if r := recover(); r != nil {
				fmt.Printf("RECOVERED ERROR %v", r)
			}
		}()
		f()
	}()
}

</code></pre>
</div>

<h2>Thinking some solutions</h2>

<p>
A couple days after the incident, I gathered the team with some alternatives and let the votes decide which was the best one for our situation (checking and guarding a set of N apicalls across several repos).
</p>

<p>
There were 3 candidates:
</p>

<h3>The obvious and hard</h3>

<p>
Not generating panics inside of the spawned goroutines. I'd wanted to patent that but I had the feeling Rob Pike already did that.
</p>

<p>
This is the ideal way but in the real world is not always possible. Most of time the are third-party dependencies or I/O driven packages which include panics as their error signaling mechanism. Getting rid of that is beyond us.
</p>

<h3>The idiomatic and ugly</h3>

<p>
How about adding this lil' gut to the beginning every new goroutine we spawn in code?
</p>

<div class="zim-object">
<pre><code class="golang">defer func() {
	if r := recover(); r != nil {
		fmt.Printf("RECOVERED - %v\r\n", r)
	}
}()
</code></pre>
</div>

<p>
It is going to work, with the disadvantage of breaking the DRY rule, becoming an extra point of failure for specialized handlers.
</p>

<p>
Remember what I said about composability? we can mitigate it with a handler like the following, as long as f is argument of another function that launches the goroutine or we ourselves launch it:
</p>

<div class="zim-object">
<pre><code class="golang">func Wrap(f func()) func() {
	return func() {
			defer func() {
				if r := recover(); r != nil {
					fmt.Printf("RECOVERED - %v\r\n", r)
				}
			}()
		f()
	}
}
</code></pre>
</div>

<p>
We'd use it the following way:
</p>

<div class="zim-object">
<pre><code class="golang">func main() {
	go Wrap(test)()
	time.Sleep(time.Second)
	fmt.Println("HELLO")
}

func test() {
	panic("PANIC")
}
//…
</code></pre>
</div>

<p>
This way, we centralize the panic handling. And last but not least, in case we want to return something from said handler, we communicate though channels:
</p>

<div class="zim-object">
<pre><code class="golang">package main

import (
	"fmt"
	"time"
)

func main() {
	signal := make(chan bool)
	go WrapWithSignal(test, signal)()

	time.Sleep(time.Second)
	fmt.Println("HELLO")

	select {
	case sig := &lt;-signal:
		if !sig {
			fmt.Println("Could not finish test execution")
		} else {
			fmt.Println("Finished test execution")
		}
	}
}

func test(signal chan bool) {
	panic("PANIC")
	signal &lt;- true
}

func WrapWithSignal(f func(chan bool), signal chan bool) func() {
	return func() {
		defer func() {
			if r := recover(); r != nil {
				fmt.Printf("RECOVERED - %v\r\n", r)
				signal &lt;- false
			}
		}()
		f(signal)
	}
}

</code></pre>
</div>

<p>
This simple pattern is idiomatic but can accumulate code smells quickly if the code has added complexity or use cases, so use it accordingly
</p>

<h2>Bonus track: Infrastructure</h2>

<p>
In order to be resilient, a service must be able to respond quickly to failures. Throwing the entire instance and requesting a new one is far from an ideal solution (in this particular case, a simple reboot of the dying webserver with a watchdog script could've been orders of magnitude faster than the default workflow).
</p>

<h2>Bonus track II: Spotting unrecovered panics</h2>

<p>
This was a dump of our middleware stack (notice the <b>RecoveryWithWriter</b> being the recovery middleware):
</p>

<div class="zim-object">
<pre><code class="haskell-literate">vendor/[ommited]/gingonic/mlhandlers.Datadog.func1
vendor/github.com/newrelic/go-agent/_integrations/nrgin/v1.Middleware.func1
vendor/[ommited]/gingonic/mlhandlers.CommonAPiFilter.func1
vendor/[ommited]/gingonic/mlhandlers.RecoveryWithWriter.func1
context.AddContext [ommited]/src/api/context.AccessLog
controllers.(*RouteCoverageController).ValidateGet-fm
controllers.(*RouteCoverageController).Get-fm
</code></pre>
</div>

<p>
And, the unhandled panic stacktrace on all of its glory:
</p>

<div class="zim-object">
<pre><code class="haskell-literate">goroutine 141 [running]:
[ommited]/src/api/services.(*CoverageService).GetCoverageServices(0xc4205ec1e0, 0x10e4e20, 0xc420073a70, 0xc420e8a41b, 0x3, 0xc420e8a41b, 0x3, 0x0, 0x0, 0x0, ...)
/services/coverage_service.go:35 +0x39
[ommited]/src/api/services.(*CoverageLocationService).GetRouteCoverage.func1(0xc400000008, 0xca6f90)
/services/coverage_locations.go:39 +0xe3
[ommited]/src/api/vendor/golang.org/x/sync/errgroup.(*Group).Go.func1(0xc42041e2c0, 0xc420426180)
/vendor/golang.org/x/sync/errgroup/errgroup.go:57 +0x57
created by [ommited]/src/api/vendor/golang.org/x/sync/errgroup.(*Group).Go
/vendor/golang.org/x/sync/errgroup/errgroup.go:54 +0x66 ```
</code></pre>
</div>

<p>
The behavior is given away by 2 things:<br>
<ol style='padding-left: 30pt' type="1" start="1">
<li>The code never passes through the recovery middleware</li>
<li>The panic occurs inside of a goroutine launched by an <a href="https://godoc.org/golang.org/x/sync/errgroup" title="errgroup.Group" class="https">errgroup.Group</a> instance</li>
</ol>
</p>



        

                
            </td>
        </tr>
        
        <tr>
            <td id="credits" colspan="2">
                <p><i><strong>Author:</strong> Luis Gabriel Gomez</i></p>
                <p><i><strong>Disclaimer:</strong> I may not own the entirety of the site media (including logos, images), thus being used under a fair use policy. All credits go to their rightful owners.</i></p>
                <p><i>This site was generated using <a href='https://zim-wiki.org'>Zim 0.73.4-da75848</a> and an author-made <a href='https://github.com/lggomez/zim-templates-gh'>theme</a> based on <a href="https://github.com/gandrille/zim-simple-web-template">Etienne Gandrille's.</a></i></p>
            </td>
        </tr>
    </table>

</body>
</html>
