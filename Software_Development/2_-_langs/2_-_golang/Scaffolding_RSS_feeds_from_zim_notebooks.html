
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="alternate" type="application/rss+xml" href="https://luisgg.me/rss.xml" title="Luis GG - Tales and notes">
    
    <meta property="og:image" content="http://luisgg.me/_assets/about-me/og.jpeg" />
    <meta property="og:title" content="Scaffolding RSS feeds from zim notebooks" />
    <meta property="og:description" content="Luis GG - Tales and notes" />

	<!-- favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <title>Scaffolding RSS feeds from zim notebooks</title>
    <meta name="generator" content="Zim 0.73.4-da75848">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="../../../_resources/style.css" type="text/css"/>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>

    <script src="../../../_resources/jquery-toc-0.4.0.js" type="text/javascript"></script>

    <script type="text/javascript">
		$(window).on('load', function () {
			// Initialize highlight.js formatter
			$('pre code').each(function (i) {
				hljs.highlightBlock(this);
            });
            
            if ($("h2").length != 0)
            $("#tocdata").toc({content: "#content", headings: "h2,h3,h4"});
            else
                $("#toc").hide();
            $("#navigation").children("ul").prepend("<li class='index-item'><a href='../../../index.html'>Index</a></li>");

            $(".toggle").addClass('toggle-off');
            $(".toggle").click(function(){
                $("#navigation").children("ul").toggle();
                var vwWidth = $(window).width();
                if ($(".toggle").hasClass('toggle-on')) {
                    $(".toggle").removeClass('toggle-on');
                    $(".toggle").addClass('toggle-off');
                    $(".wrapper").css('max-width', vwWidth + '%');
                    $(".wrapper").css('width', vwWidth + 'vw');
                } else if ($(".toggle").hasClass('toggle-off')) {
                    $(".toggle").removeClass('toggle-off');
                    $(".toggle").addClass('toggle-on');
                    $(".wrapper").css('max-width', vwWidth + '%');
                    $(".wrapper").css('width', vwWidth + 'vw');
                }
            });
            $("img").wrap("<div class='imgcenter'></div>");
        });
	</script>
</head>
<body>
    <noscript>
        <div style="border: 1px solid purple; padding: 10px">
            <span style="color:red">This page is best viewed with JavaScript enabled!</span>
        </div>
    </noscript>

    <table id="wrapper">
        <tr>
            <td id="navigation" rowspan="2">
                <svg class="toggle">
                    <line x1="10" y1="10" x2="40" y2="10" />
                    <line x1="10" y1="20" x2="40" y2="20" />
                    <line x1="10" y1="30" x2="40" y2="30" />
                </svg> 
                <ul>
<li><a href="../../../About_Me.html" title="About Me" class="page">About Me</a></li>
<li><a href="../../../About_RSS_feed.html" title="About RSS feed" class="page">About RSS feed</a></li>
<li><a href="../../../Arduno_and_electronics.html" title="Arduno and electronics" class="page">Arduno and electronics</a></li>
<li><a href="../../../Misc.html" title="Misc" class="page">Misc</a></li>
<li><a href="../../../Software_Development.html" title="Software Development" class="page">Software Development</a>
<ul>
<li><a href="../../1_-_Talks_and_Presentations.html" title="1 - Talks and Presentations" class="page">1 - Talks and Presentations</a></li>
<li><a href="../../2_-_langs.html" title="2 - langs" class="page">2 - langs</a>
<ul>
<li><a href="../1_-_dotNET.html" title="1 - dotNET" class="page">1 - dotNET</a></li>
<li><a href="../2_-_golang.html" title="2 - golang" class="page">2 - golang</a>
<ul>
<li><a href="./1_-_Talks_and_Presentations.html" title="1 - Talks and Presentations" class="page">1 - Talks and Presentations</a></li>
<li><a href="./2_-_When_gophers_attack.html" title="2 - When gophers attack" class="page">2 - When gophers attack</a></li>
<li><b>Scaffolding RSS feeds from zim notebooks</b></li>
</ul>
</li>
<li><a href="../The_otherworldly_landscape_of_enums_in_go.html" title="The otherworldly landscape of enums in go" class="page">The otherworldly landscape of enums in go</a></li>
</ul>
</li>
<li><a href="../../3_-_Articles.html" title="3 - Articles" class="page">3 - Articles</a></li>
<li><a href="../../4_-_Notes.html" title="4 - Notes" class="page">4 - Notes</a></li>
</ul></li>
</ul>

            </td>

            <td id="header">
                <h1><a href="/">Luis GG - Tales and notes</a></h1>
            </td>
        </tr>

        <tr>
            <td id="content">


                    <h1>Scaffolding RSS feeds from zim notebooks <a name='Software Development:2 - langs:2 - golang:Scaffolding RSS feeds from zim notebooks'></a></h1>
                    <div id="toc">			
                        <div class="toctitle">Contents</div>				
                        <ul id="tocdata"></ul>
                    </div>		

                <p>
Created Saturday 23 January 2021
</p>

<p>
As mentioned <a href="https://luisgg.me/About_RSS_feed.html" title="after the fact" class="https">after the fact</a>, this site is built from a zim notebook and RSS generation is not one of the features included in zim as of today, so I immediately went into researching how to achieve this in the most straightforward but automatic way possible
</p>

<h2>Some notes on zim format</h2>

<p>
Zim notebooks are file tree structures and tipically consist of 3 things:<br>
<ul>
<li>The zim notebook definition file, <b>notebook.zim</b>, which is located at the root directory. The format of this file is the same as .ini files, containing a main [Notebook] key with the notebook metadata and additional top level entries for plugins</li>
<li>The wiki pages themselves, on txt format (at least by default). These files have an unique format with metadata present in the first 6 lines of the file</li>
<li>The directories which contain subentries. These directories are accompanied by an equally named page, so that the directory is present in the wiki structure itself </li>
</ul>
</p>

<h2>Some notes on RSS</h2>

<p>
The complete RSS structure and documentation can be read <a href="https://www.xul.fr/en-xml-rss.html#structure" title="here" class="https">here</a>, but sometimes a code snippet and some bullets say more than a thousand words:
</p>

<div class="zim-object">
<pre><code class="xml">&lt;?xml version="1.0" ?&gt;
&lt;rss version="2.0"&gt;
&lt;channel&gt;
  &lt;title&gt;Main site title&lt;/title&gt;
  &lt;link&gt;https://www.foo.com&lt;/link&gt;
  &lt;description&gt;Site description&lt;/description&gt;
  &lt;managingEditor&gt;mail@example.com (Author Name)&lt;/managingEditor&gt;
  &lt;pubDate&gt;Wed, 23 Dec 2020 21:19:19 -0300&lt;/pubDate&gt;
  &lt;image&gt;
      &lt;url&gt;https://www.foo.com/icon.gif&lt;/url&gt;
      &lt;link&gt;https://www.foo.com/index.php&lt;/link&gt;
  &lt;/image&gt;
  &lt;item&gt;
      &lt;title&gt;Article 1&lt;/title&gt;
      &lt;link&gt;https://www.foo.com/article1.html&lt;/link&gt;
      &lt;description&gt;item description&lt;/description&gt;
      &lt;author&gt;Author Name&lt;/author&gt;
      &lt;pubDate&gt;Fri, 15 Jan 2021 20:34:28 -0300&lt;/pubDate&gt;
  &lt;/item&gt;
  &lt;item&gt;
      &lt;title&gt;Article 2&lt;/title&gt;
      &lt;link&gt;https://www.foo.com/article2.html&lt;/link&gt;
      &lt;description&gt;item description&lt;/description&gt;
      &lt;author&gt;Author Name&lt;/author&gt;
      &lt;pubDate&gt;Fri, 17 Jan 2021 21:35:29 -0300&lt;/pubDate&gt;
  &lt;/item&gt;
&lt;/channel&gt;
&lt;/rss&gt; 
</code></pre>
</div>

<p>
<ul>
<li>Format is XML (to dispel any remaining doubts)</li>
<li>Top level element channel contains the entire feed</li>
<li>Sub-elements are classified in two types:
<ul>
<li>Site metadata attributes</li>
<li>Item attributes, which are the articles themselves and their metadata</li>
</ul>
</li>
<li>Additionally, items can contain the entire article via the <i>&lt;content&gt; </i>tag, but since we assume the content we're dealing with still hasn't been scaffolded to HTML the usage of this field is outside the scope of this project</li>
</ul>
</p>

<h2>Putting stuff together in go</h2>

<p>
The aim is to do the scaffolding in 3 steps:
</p>

<p>
<ol type="1" start="1">
<li>Notebook traversal &amp; metadata retrieval</li>
<li>RSS entity generation</li>
<li>XML file generation</li>
</ol>
</p>

<p>
For reading the notebook file and generating the RSS feed respectively, the following packages were used (and very useful):
</p>

<p>
<ul>
<li><a href="http://github.com/gookit/ini/v2" title="github.com/gookit/ini/v2" class="http">github.com/gookit/ini/v2</a></li>
<li><a href="http://github.com/gorilla/feeds" title="github.com/gorilla/feeds" class="http">github.com/gorilla/feeds</a></li>
</ul>
</p>

<p>
Also, <a href="http://github.com/jessevdk/go-flags" title="github.com/jessevdk/go-flags" class="http">github.com/jessevdk/go-flags</a> always comes in handy for basic commandline parsing on tagged structs
</p>

<p>
The traversal becomes very simple by using the filepath.Walk function, which does a lexical BFS traversal of the directory (which makes it deterministic but may suffer performance-wise on dense directory structures, which is not our case). The main code is the following:
</p>

<div class="zim-object">
<pre><code class="golang">func traverseAndParsePageMetadata(rootPath string, notebookPath string) zim.PageMetadataByCreationDate {
	pages := zim.PageMetadataByCreationDate{}
	walkErr := filepath.Walk(rootPath, func(path string, info os.FileInfo, err error) error {
		if path == notebookPath {
			return nil // ignore base notebook file
		}
		if err != nil {
			return err
		}
		if !info.Mode().IsRegular() {
			return nil
		}

		if !info.IsDir() {
			// TODO: Detect and ignore empty pages? (with empty content starting from line 7)
			pageMetadata, err := zim.ParsePage(path, info)
			if err != nil {
				return err
			}

			pages = append(pages, pageMetadata)
		}

		return nil
	})
	if walkErr != nil {
		panic(walkErr)
	}
	return pages
}

</code></pre>
</div>

<p>
Then, RSS generation si similarilly simple:
</p>

<div class="zim-object">
<pre><code class="golang">func createRSSFeed(pages zim.PageMetadataByCreationDate, rootPath string, zimNotebook zim.Notebook) (string, error) {
	// Create main feed element
	feed := &amp;feeds.Feed{
		Title:       commandlineFlags.Title,
		Link:        &amp;feeds.Link{Href: commandlineFlags.Link},
		Description: commandlineFlags.Description,
		Author:      &amp;feeds.Author{Name: commandlineFlags.AuthorName, Email: commandlineFlags.AuthorEmail},
		Created:     pages[0].CreationDate.Add(-(60 * time.Minute)), // Use 1 hour prior to the first page creation as an arbitrary creation date
	}

	items := make([]*feeds.Item, 0, len(pages))
	for _, p := range pages {
		pageLink := p.PathToURL(rootPath, commandlineFlags.Link, zimNotebook.DefaultFileExtension)
		items = append(items, &amp;feeds.Item{
			Title: p.Title,
			Link:  &amp;feeds.Link{Href: pageLink},
			//Description: , TODO: no description available from page so this will be filled manually on generated file
			Author:  &amp;feeds.Author{Name: commandlineFlags.AuthorName, Email: commandlineFlags.AuthorEmail},
			Created: p.CreationDate,
		})
	}
	feed.Items = items

	rss, err := feed.ToRss()
	if err != nil {
		log.Fatal(err)
	}
	return rss, nil
}
</code></pre>
</div>

<p>
Finally, creating the file is just a matter of saving the return value of <i>createRSSFeed...</i>
</p>

<div class="zim-object">
<pre><code class="golang">	// Write RSS feed file
	f, err := os.Create("rss.xml")
	if err != nil {
		log.Fatal(err)
	}
	defer f.Close()
	f.WriteString(rss)
</code></pre>
</div>

<p>
... and that's it, now we have and RSS feed file. All that remains is adding any additional info that we want (like the article descriptions or the site image)
</p>

<p>
The commandline application's code is available at <a href="https://github.com/lggomez/go-zimrss" title="https://github.com/lggomez/go-zimrss" class="https">https://github.com/lggomez/go-zimrss</a> for anyone interested
</p>


        

                
            </td>
        </tr>
        
        <tr>
            <td id="credits" colspan="2">
                <p><i><strong>Author:</strong> Luis Gabriel Gomez</i></p>
                <p><i><strong>Disclaimer:</strong> I may not own the entirety of the site media (including logos, images), thus being used under a fair use policy. All credits go to their rightful owners.</i></p>
                <p><i>This site was generated using <a href='https://zim-wiki.org'>Zim 0.73.4-da75848</a> and an author-made <a href='https://github.com/lggomez/zim-templates-gh'>theme</a> based on <a href="https://github.com/gandrille/zim-simple-web-template">Etienne Gandrille's.</a></i></p>
            </td>
        </tr>
    </table>

</body>
</html>
